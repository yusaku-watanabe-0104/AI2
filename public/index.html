<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>三角比の達成価値</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 40px auto; padding: 0 1em; background: #fafafa; }
    .chat { display:flex; flex-direction:column; gap:1em; }
    .bubble { padding:10px 15px; border-radius:10px; max-width:80%; white-space:pre-wrap; line-height:1.5; }
    .ai { background:#e6f7ff; align-self:flex-start; }
    .user { background:#d1ffd6; align-self:flex-end; }
    #inputArea { display:flex; margin-top:1em; gap:.5em; }
    #userInput { flex:1; padding:.5em; }
    button { padding:.5em 1em; }
  </style>
</head>
<body>
  <h1>あなたにとっての三角比の意味</h1>
  <img src="https://illust8.com/wp-content/uploads/2023/06/senior_teacher_18894.png" alt="年配の先生のイラスト" width="200" />
  <div id="chat" class="chat">
    <div class="bubble ai">こんにちは。これからいくつか質問をしますね。</div>
  </div>

  <div id="inputArea">
    <input type="text" id="userInput" placeholder="ここに入力してください" />
    <button onclick="handleInput()">送信</button>
  </div>

  <script>
    let step = 0;
    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");
    const answers = {};
    const questions = [
      "出席番号を教えてください。",
      "あなたは自分のことをどんな人間だと思っていますか？",
      "あなたの理想の自分を教えてください。",
      "普段の生活や学校での行動を決めるとき、特に大事にしていることはありますか？",
      "近い未来（１年〜５年ほど）の目標を教えてください。",
      "何かに挑戦するとき、目標は「自分が成長すること」それとも「人よりも良い結果を出すこと」どちらが気になりますか？",
      "あなたはクラスにおいて，どんな役割を果たすことを期待されていると思いますか？"
    ];
    const keys = ["number", "selfImage", "idealSelf", "values", "future", "recentEffort", "kitai"];
    let afterValuePhase = false;
    let reflectionAsked = false;
    let finalFeedbackWaiting = false;
    let finalFeedbackSent = false;

    let firstAiResponse = "";

    function addMessage(text, sender="ai") {
      const bubble = document.createElement("div");
      bubble.className = `bubble ${sender}`;
      bubble.textContent = text;
      chat.appendChild(bubble);
      chat.scrollTop = chat.scrollHeight;
    }

    async function handleInput() {
    const value = input.value.trim();
    if (!value) return;
    addMessage(value, "user");
    input.value = "";

    // 質問フェーズ (1回目のAI呼び出し: generateAICompletion)
    if (!afterValuePhase) {
        // ... (省略: 質問フェーズのロジックは変更なし) ...
        answers[keys[step]] = value;
        step++;
        if (step < questions.length) {
            setTimeout(() => addMessage(questions[step], "ai"), 600);
        } else {
            addMessage("少し考えますね…", "ai");
            await generateAICompletion(); 
        }
    } 
    // 反省フェーズ (2回目のAI呼び出し: generateReflectionReply)
    else if (!reflectionAsked) {
        // ユーザーの反省回答を受け取り、AIで応答を作る
        reflectionAsked = true;
        await generateReflectionReply(value); // 2回目の呼び出し

        // 3回目の応答の前にユーザー入力を挟むための待機状態へ移行
        setTimeout(() => {
            addMessage("自分の目標に対して、この文章はどのように役立つと思いますか？", "ai");
            finalFeedbackWaiting = true; 
        }, 1000);
    } 
    // 最終フィードバック待機フェーズ
    else if (finalFeedbackWaiting) {
        // ユーザーが何か入力したら、3回目のAI応答を実行
        finalFeedbackWaiting = false; 
        await generateFinalFeedback(); // 3回目の呼び出し
        finalFeedbackSent = true;
    }
    
    // その他の状態（念のため）
    else {
        const reply = simpleReply(value);
        setTimeout(() => addMessage(reply, "ai"), 700);
    }
}

    // --- 価値促進メッセージをAI生成する関数 ---
    async function generateAICompletion() {
      // --- カスタマイズポイント（ここを編集してプロンプトを変える） ---
      const pdfText = "We define attainment value in terms of the personal importance attached to doing well on, or participating in, a given task. Our notion of attainment value is closely linked to work on identity: tasks are seen as important when engaging in them is central to individuals' core social and personal identities, because such tasks provide the opportunity to express or confirm important aspects of the self. Connell and Wellborn (1991) argued that motivation is influenced by opportunities to fulfill basic needs for autonomy, relatedness, and competence. We add: 1. the need to feel that what one does matters to one’s social group, and 2. the need to feel respected and valued by it. The attainment value of tasks is influenced by how they fulfill personal needs and values. As we grow up, we develop images of who we are and want to be, including: (1) our personality and capabilities, (2) long-range goals and plans, (3) schemas about proper roles of people “like us,” (4) instrumental and terminal values, (5) motivational sets or goal orientations, and (6) ideal or hoped-for selves. These images form our social and personal identities, which powerfully influence the value we attach to activities. People value tasks that align with their identity and goals, and select tasks with high subjective value. Thus, different identities shaped by sociocultural learning (e.g., gender) lead to different valuations of the same activities.";
      const prompt = `${pdfText}
上記の文章は達成価値の定義や特性を述べたものです．
あなたは教育に熱心な高校数学の先生です。
以下の情報を参考に、私にとっての三角比についての達成価値を、学習範囲の具体例を交えながら400文字程度で高校生に親しみやすいように話し言葉で説明してください。「達成価値」という言葉は用いなくて大丈夫です．
また学習内容は，鋭角についての三角比は学習しました．これから鈍角の三角比を学習します．

 私は自分を「${answers.selfImage}」と捉えています。
- 私の理想の自分は「${answers.idealSelf}」です。
- 私が普段の生活や学校での行動を決めるとき、特に大事にしていることは「${answers.values}」です。
- 私の近い将来の目標は「${answers.future}」です。
- 私は何かに挑戦するとき、目標は「${answers.recentEffort}」ことです。
- 私はクラスにおいて，「${answers.kitai}」することを期待されていると思います。

これらの私の特徴は上記の達成価値の特性の文章における社会的・個人的アイデンティティを構成する６つの要素に沿っています。
上から(1),(6),(4),(2),(5),(3)です。
`;


      // --- サーバーへ送信 ---
      try {
        addMessage("AIに問い合わせ中…", "ai");
        const res = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt, answers })
        });
        const data = await res.json();
        const aiText = data.completion || "（AIの応答がありませんでした）";
        firstAiResponse = aiText;
        addMessage(aiText, "ai");

        // 価値促進メッセージの後に反省質問を投げる
        setTimeout(() => {
          addMessage("この文章の中で，間違っていると思う部分はありますか", "ai");
          afterValuePhase = true;
        }, 700);

      } catch (err) {
        console.error(err);
        addMessage("サーバーとの通信に失敗しました。", "ai");
      }
    }

    // --- 反省（リフレクション）に対するAI返信を生成 ---
    async function generateReflectionReply(userAnswer) {
      // --- カスタマイズポイント（ここを編集して返しのトーンや長さを変える） ---
      const prompt = `
あなたは高校数学の先生です。
以前、あなたは生徒に次の数学の価値促進メッセージを送りました：
「${firstAiResponse}」
あなたが提示した文章に対して，間違っている部分を生徒が次のように回答しました：
"${userAnswer}"

この回答を受けて、300文字程度で間違いの指摘が適切なものなのかをフィードバックしてください。
`;
      try {
        addMessage("少し待ってね", "ai");
        const res = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt, answers })
        });
        const data = await res.json();
        const aiText = data.completion || "（AIの応答がありませんでした）";
        addMessage(aiText, "ai");
      } catch (err) {
        console.error(err);
        addMessage("サーバーとの通信に失敗しました。", "ai");
      }
    }

    function simpleReply(text) {
      const samples = [
        "なるほど、その考え方はいいですね。",
        "いい視点です。次はどうつなげられるか考えてみましょう。",
        "面白いですね！ その感覚を大切にしてください。"
      ];
      return samples[Math.floor(Math.random() * samples.length)];
    }

    async function generateFinalFeedback() {
        // プロンプトは、これまでの全ての回答を総合的に評価して、生徒に最終的な励ましを与える内容にします。
        const finalPrompt = `
あなたは教育に熱心な高校数学の先生です。
生徒の全ての回答（answers変数内）と、これまでの対話の文脈全体を考慮し、生徒がこれから三角比の学習に入るにあたって、**最も心に残るような、前向きで、学びへの関心を高める、最終的な励ましのメッセージ（250文字程度）**を生成してください。
すべての回答: ${JSON.stringify(answers)}
`;
        try {
            addMessage("少し待ってね", "ai");
            // サーバーの既存の /api/generate を利用し、3回目のAI応答を生成
            const res = await fetch("/api/generate", { 
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: finalPrompt, answers: answers }) // answersは保存のために渡します
            });
            const data = await res.json();
            const aiText = data.completion || "（AIの応答がありませんでした）";
            addMessage(aiText, "ai");
            setTimeout(() => {
                addMessage("これで終了です。お疲れ様でした！", "ai"); // 終了メッセージ
                document.getElementById('userInput').disabled = true;  // 入力欄の無効化
                document.querySelector('button').disabled = true; // ボタンの無効化
                finalFeedbackSent = true; // 状態を更新
            }, 1500);
        } catch (err) {
            console.error(err);
            addMessage("最終フィードバックの生成に失敗しました。", "ai");
        }
    }

    // 初回質問を表示
    addMessage(questions[0], "ai");
  </script>
</body>
</html>
